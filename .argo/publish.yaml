---
type: workflow
version: 1
name: build-publish
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    tracking-id:
      default: "UA-105170809-1"
    href-base:
      default: "/argo-site/"
    base-url:
      default: "https://argoproj.github.io"
    docs-branch:
      default: "production"
steps:
- build:
    template: build
    arguments:
      parameters.href-base: "%%inputs.parameters.href-base%%"
      parameters.tracking-id: "%%inputs.parameters.tracking-id%%"
      parameters.docs-branch: "%%inputs.parameters.docs-branch%%"
- publish:
    image: argoproj/argoscm:v2.0
    command: ["sh", "-c"]
    args: [
      axscm clone %%inputs.parameters.repo%% --commit gh-pages /src &&
      cd /src && rm -rf ./assets && rm -rf ./docs && rm ./index.html && rm ./webpack-assets.json &&
      cp -r /argo-site/dist_rendered/* . && cp ./index.html ./404.html && rm ./docs/.gitignore &&
      git add . && git commit -m "Build on `date`" &&
      axscm clone %%inputs.parameters.repo%% /src --commit gh-pages --merge=gh-pages --push]
    resources:
      mem_mib: 500
      cpu_cores: 0.1
    inputs:
      artifacts:
        code:
          from: "%%steps.build.outputs.artifacts.code%%"
          path: /argo-site
