# Tutorial 2: Build and Deploy Docker Image using DinD

This tutorial shows how to easily build and deploy docker images on Kubernetes.

In an Argo workflow, every step must be defined as a container specification and creates a Kubernetes job. In some cases, you may need to run a Docker container within a Docker container. You may want to build a Docker container image inside your containerized CI job..

To build a Docker container image within our Docker container step, Argo uses the Docker-in-Docker (DinD) technique. If you are interested in knowing more about how DinD works, please see our blog on [https://applatix.com/case-docker-docker-kubernetes-part/](https://applatix.com/case-docker-docker-kubernetes-part/)

## Run a Docker Build and Deploy (DinD) Workflow

1.  Go to the sample `DinD` workflow repository at [https://github.com/argoproj](https://github.com/argoproj).
2.  Review the `dind-workflow.yaml` file under `.argo` folder in that repo. It has a checkout, build, approval and deploy step. Every step in the workflow needs to be defined as a container specification and creates a Kubernetes job. The `dind-workflow.yaml` workflow checks out code, builds a node.js image, pushes the image to Docker hub and then deploys it as a Kubernetes deployment.

    To enable a Docker-in-Docker workflow, you must add two lines to the container template that is part of this workflow:

    ```
    annotations:
    ax_ea_docker_enable: '{"graph-storage-size": "10Gi", "cpu_cores":0.1, "mem_mib":200}'
    ```

    For more details these two lines of YAML DSL code, please check the YAML reference at [Container Calling Docker Commands "Docker-in-Docker"](container_templates.htm#ContainerDinDWorkflow).

    To make the credentials secure for accessing the container registry, the YAML DSL example uses Argo Secret management to encrypt the user id and password.

3.  Since your Argo installation is automatically integrated with [https://github.com/argoproj](https://github.com/argoproj) repo, you can view it in your Argo dashboard under Catalog menu item along with other samples.
4.  Select DinD in the Catalog item and click Run to start the DinD build and deploy workflow.
5.  This workflow has a approval step which needs an email address as a mandatory input parameter called REQUIRED_APPROVALS. Enter an email id and click submit
6.  You will see the workflow running in Argo Web UI where every step is a container. You can check the log and artifact generated by clicking on each step.
7.  Once the workflow completes you will see a "Sampleapp" application deployed under Applications tab in Argo Web UI.
8.  Since your Argo installation is automatically integrated with [https://github.com/argoproj](https://github.com/argoproj) repo, you can view it in your Argo dashboard under Catalog menu item along with other samples
9.  Select DinD in the Catalog item and click Run to start the DinD build and deploy workflow.
10.  This workflow has a approval step which needs an email address as a mandatory input parameter called REQUIRED_APPROVALS. Enter an email id and click submit
11.  You will see the workflow running in Argo Web UI where every step is a container. You can check the log and artifact generated by clicking on each step.
12.  Once the workflow completes you will see a "Sampleapp" application deployed under Applications tab in Argo Web UI.

## Create and Run yourCustom Docker Build and Deploy Workflow

### Create your YAML files

1.  Create a `.argo` folder under your repository
2.  Copy YAML templates from [https://github.com/argoproj/dind/](https://github.com/argoproj/dind/) to your `.argo` folder.
3.  `argo_checkout.yaml` defines a container that Argo provides for checking out code in your AWS S3 which can be accessed by your other workflow steps. You shouldn't need to modify it.
4.  `argoapproval.yaml` defines a container provided by Argo for sending email for approval. You shouldn't need to modify it.
5.  Customize the `dind-workflow.yaml` file with your build and deploy containers.
6.  (Optional) The `dind-project.yaml` file defines how it will show up in your Catalog menu. You only need this file if you want workflow to show up in your Catalog. Otherwise you can run the workflow against your commits in Timelines menu. You can also see and run all your YAML templates under Templates menu.
7.  If you want to add more test steps or configure a policy to automatically trigger this workflow, then please review the steps and YAML template files in the CI-workflow tutorial.

### Manually Run Your Workflow

1.  Since your Argo installation is integrated with your repo, you will see your commits in Argo Web UI under Timeline menu item
2.  You can select any commit, click Create a new job. Select the workflow name, enter a value for the input parameter, and click on Submit.

### Automatically Trigger Your Workflow

1.  To set up a policy to automatically trigger this workflow, please review the steps for policy creation and YAML templates under the CI-workflow tutorial
2.  In Argo web UI, go to Templates menu, search for that policy and click Enabled.
3.  For every commit on that repo, your workflow will get triggered based on your policy.
