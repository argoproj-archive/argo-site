# Tutorial 2: Build a Docker Image using DinD

This tutorial shows how to easily build Docker images on Kubernetes.

As mentioned Tutorial 1, an Argo Workflow consists of steps and each step runs as a Docker container within a Kubernetes pod. However, sometimes you may need to run a Docker container within a Docker container (such as building a Docker container image inside your containerized CI job). These are the steps you'll run in the sample workflow for building Docker images:

* Checkout code
* Build the Docker container within a Docker container

NOTE: Argo uses the Docker-in-Docker (DinD) technique to build a Docker container image within our Docker container step. To learn about how the DinD technique works, see [https://applatix.com/case-docker-docker-kubernetes-part/](https://applatix.com/case-docker-docker-kubernetes-part/)

## Prerequisites
This tutorial assumes the following:

* You have successfully [installed Argo](https://argoproj.github.io/argo-site/get-started/installation).
* You have integrated Argo with the sample DinD repo at https://github.com/argoproj/example-dind.

## About the YAML Templates

The workflow "building Docker images" uses 2 YAML files from the repo at https://github.com/argoproj/example-dind/tree/master/.argo:

* `dind-workflow.yaml` - creates a container for checking out code, builds a node.js image, pushes the image to Docker hub. To enable a Docker-in-Docker workflow, you must add two lines to the container template that is part of this workflow:

  ```
  annotations:
    ax_ea_docker_enable: '{"graph-storage-size": "10Gi", "cpu_cores":0.1, "mem_mib":200}'
  ```
For more details about the two lines of YAML code, see [Container Calling Docker Commands "Docker-in-Docker"](../yaml/container_templates.md#ContainerDinDWorkflow).

* `dind-project.yaml` - specifies the YAML template for launching the workflow from the Catalog and also the assets for publishing the project in the Catalog.

NOTE: To make the credentials secure for accessing the container registry, this YAML DSL example uses [Argo Secret Management](../user_guide/configapplatixcluster/managesystemsettings.md) to encrypt the user id and password.

## Run a DinD Build Workflow

1. In the Argo Web UI, select **Catalog** > **Demo** > **Docker in Docker** and click **BUILD USING DIND**.
1. Click **Submit** to start the DinD build workflow.

You can see the workflow status from the Argo Web UI. You can also check the logs and artifacts generated by each step:

![DinD-workflow](../../images/example-dind-workflow.png)

When the workflow completes, click **Timeline** > **Jobs** you'll see a "Successful on <date>" status on your DinD build job.

## Customize Your DinD Build Workflow

1. In your own repo, create a directory called `.argo`. (The Argo Workflow engine uses this directory to look for the YAML files to run for a containerized workflow.)
1. Copy the YAML templates you ran in the sample workflow for building and deploying Docker images from [https://github.com/argoproj/example-dind/tree/master/.argo](https://github.com/argoproj/example-dind/tree/master/.argo) to the `.argo` folder you just created in your repo.
1. Customize the `dind-workflow.yaml` file by writing your own build container or adding more steps.

	For more details about writing the YAML DSL, see [Argo YAML DSL Reference](./../yaml/dsl_reference_intro.md).

4.  (Optional) Modify the `dind-project.yaml` file to give users the option to run the project from the Catalog menu. If you do not want to provide this option, then users can run the workflow against your commits displayed in the **Timelines** menu. You can also run all your YAML templates from the **Templates** menu.

When you integrate your repo with Argo, the Argo Web UI will display your source code commits in the **Timeline** menu item.

## Running Your Customized DinD Build Workflow

You have two options for running your customized DinD build workflow:

 * **Manually**

	1. Go to **Timeline** menu, select a commit and click **Create a New Job**.
	1. Select the YAML templates to create a job, click **NEXT**, enter values for the input parameters and click **Submit**.  
<br/>
   (Optional) If you want your DinD-build Workflow to show up in your Catalog menu, just copy the `dind-project.yaml` file into the `.argo` directory in your repo. Modify the reference to the YAML template file that is launched to run this workflow.


* **Automatically**

	1. Copy the `example-policy.yaml` file to the `.argo` directory in your repo and modify it as needed.
	1. Enable your policy template. (**Templates** > *name_of_policy_template* > and click **Enabled**)  
   <br/> After you've completed these steps, every time you make a commit in your repo, the CI workflow is automatically triggered.
